<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocol v8.6 - Final Stable</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #050505; color: #e0e0e0; padding: 10px; text-align: center; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; max-width: 1200px; margin: 15px auto; }
        .slot { background: #0f0f0f; padding: 12px; border-radius: 12px; border: 1px solid #1a1a1a; display: flex; flex-direction: column; min-height: 120px; transition: 0.3s; }
        .label { font-size: 0.55rem; color: #444; text-transform: uppercase; margin-bottom: 6px; letter-spacing: 1px; }
        .res-box { font-size: 1.2rem; font-weight: bold; color: #00e5ff; margin-bottom: 8px; }
        
        .counter-btn { background: #1a1a1a; color: #fff; border: 1px solid #333; padding: 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; margin-top: auto; font-weight: bold; }
        .counter-btn:active { background: #222; transform: scale(0.98); }
        .reroll-small { background: #222; color: #555; border: none; font-size: 0.55rem; padding: 4px 8px; border-radius: 4px; cursor: pointer; margin-top: 5px; text-transform: uppercase; }
        .reroll-small:disabled { color: #111 !important; cursor: not-allowed; }

        #timer-display { font-size: 12vw; max-font-size: 4rem; font-family: 'Courier New', monospace; margin: 8px 0; color: #ffcc00; }
        .roll-btn { background: #2979ff; color: white; padding: 16px; font-size: 1.1rem; width: 90%; max-width: 400px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-bottom: 10px;}
        .done-btn { background: #00c853; color: white; padding: 18px; font-size: 1.4rem; display: none; margin: 15px auto; width: 90%; border:none; border-radius:8px; font-weight:bold; cursor:pointer;}
        
        #status-msg { font-size: 1.1rem; font-weight: bold; margin-top: 10px; min-height: 30px; color: #888; }
        .punish-box { color: #d500f9; border: 1px solid #d500f9; background: rgba(213, 0, 249, 0.05); padding: 5px; border-radius: 4px; font-size: 0.75rem; margin-top: 5px; }
        .rejected-style { color: #ff1744; border: 2px solid #ff1744; padding: 15px; border-radius: 8px; background: rgba(255, 23, 68, 0.1); width: 80%; margin: 20px auto; font-weight: bold; }
    </style>
</head>
<body>

    <h1 style="color: #1a1a1a; font-weight: 300; margin: 10px 0; font-size: 0.7rem; letter-spacing: 5px;">PROTOCOL V8.6</h1>

    <div class="grid">
        <div class="slot" id="slot1">
            <div class="label">Target Edges</div>
            <div id="res1" class="res-box">—</div>
            <button id="edgeCountBtn" class="counter-btn" style="display:none" onclick="increment('edge')">LOG EDGE: <span id="edgeVal">0</span></button>
        </div>
        <div class="slot" id="slot2">
            <div class="label">Method</div>
            <div id="res2" class="res-box">—</div>
        </div>
        <div class="slot" id="slot3">
            <div id="label3" class="label">Requirement</div>
            <div id="res3" class="res-box">—</div>
            <button id="prostateCountBtn" class="counter-btn" style="display:none" onclick="increment('prostate')">LOG ORGASM: <span id="prosVal">0</span></button>
        </div>
        <div class="slot">
            <div class="label">Fast Until</div>
            <div id="res5" class="res-box">—</div>
            <div style="margin-top: auto;">
                <button class="reroll-small" id="rerollDayBtn" onclick="triggerReroll()">Reroll</button>
                <div id="reroll-count" style="font-size:0.5rem; color:#444">Left: 4</div>
            </div>
        </div>
        <div class="slot" id="slot4">
            <div class="label">Outcome</div>
            <div id="res4" class="res-box">—</div>
        </div>
        <div class="slot" id="slotPOT">
            <div class="label">End Enforcement</div>
            <div id="resPOT" class="res-box">—</div>
            <div id="punishDetails" class="punish-box" style="display:none"></div>
        </div>
    </div>

    <button class="roll-btn" id="startBtn" onclick="startSession()">GENERATE SESSION</button>
    <div id="timer-display">00:00:00</div>
    <button id="doneBtn" class="done-btn" onclick="finishSession()">I HAVE FINISHED</button>
    
    <div id="status-msg"></div>

<script>
    let timerInterval, timeLeft, sessionActive = false, isRejected = false, rerollsRemaining = 4;
    let counts = { edge: 0, prostate: 0 };

    function rollFastUntil(maxDays) {
        let pool = [];
        for (let i = 1; i <= maxDays; i++) {
            let weight = (i <= 2) ? 40 : 10;
            for (let j = 0; j < weight; j++) pool.push(i);
        }
        document.getElementById('res5').innerText = pool[Math.floor(Math.random() * pool.length)] + " DAYS";
    }

    function triggerReroll() { 
        if (rerollsRemaining > 0 && !isRejected) {
            rerollsRemaining--;
            document.getElementById('reroll-count').innerText = `Left: ${rerollsRemaining}`;
            rollFastUntil(30); 
        }
    }

    function startSession() {
        isRejected = false; sessionActive = false; clearInterval(timerInterval);
        rerollsRemaining = 4;
        counts = { edge: 0, prostate: 0 };
        document.getElementById('edgeVal').innerText = "0";
        document.getElementById('prosVal').innerText = "0";
        document.getElementById('reroll-count').innerText = `Left: ${rerollsRemaining}`;
        document.getElementById('rerollDayBtn').disabled = false;
        document.getElementById('punishDetails').style.display = "none";
        document.getElementById('status-msg').innerText = "";
        document.getElementById('doneBtn').style.display = "none";
        document.getElementById('edgeCountBtn').style.display = "none";
        document.getElementById('prostateCountBtn').style.display = "none";
        document.getElementById('res3').innerText = "---";

        const roll = Math.random() * 100;
        if (roll < 17.5) { 
            handleRejection(); 
        } else { 
            handleAllowed(); 
        }
    }

    function handleRejection() {
        isRejected = true;
        document.getElementById('res2').innerText = "DENIED";
        document.getElementById('rerollDayBtn').disabled = true;
        document.getElementById('status-msg').innerHTML = '<div class="rejected-style">SYSTEM LOCKOUT: ACCESS DENIED</div>';
        rollFastUntil(4);
        ['res1','res3','res4','resPOT'].forEach(id => document.getElementById(id).innerText = "---");
    }

    function handleAllowed() {
        const mSub = Math.random() * 100;
        let method = "Just Hand";
        
        // Method Logic
        if (mSub < 1) method = "Prostate Only";
        else if (mSub < 6) method = "Just Hand"; 
        else if (mSub < 16) method = "Numbing Cream";
        else if (mSub < 25) method = "Prostate";
        
        document.getElementById('res2').innerText = method;

        // Requirement Logic (Restored Missing Feature)
        if (method.includes("Prostate")) {
            const pNeed = Math.floor(Math.random() * 3) + 1;
            document.getElementById('res3').innerText = pNeed + " ORGASMS";
            document.getElementById('prostateCountBtn').style.display = "block";
        } else {
            document.getElementById('res3').innerText = "STANDARD";
        }

        // Target Edges
        let maxE = (method === "Numbing Cream") ? 3 : 30;
        document.getElementById('res1').innerText = Math.floor(Math.random() * maxE) + 1;
        document.getElementById('edgeCountBtn').style.display = "block";

        // Outcome Logic
        const outcome = (mSub >= 1 && mSub < 6) ? "Ruined Orgasm Only" : (Math.random() < 0.6 ? "To Cum" : "Not To Cum");
        document.getElementById('res4').innerText = outcome;
        rollFastUntil(30);

        // Enforcement/Penalty Logic
        const potEl = document.getElementById('resPOT');
        const detailEl = document.getElementById('punishDetails');
        
        if (outcome === "To Cum" || outcome === "Ruined Orgasm Only") {
            const eRoll = Math.random() * 100;
            if (eRoll < 15 && method !== "Numbing Cream") {
                const extra = Math.random() < 0.7 ? "Twice" : "3 Times";
                potEl.innerText = "PUNISHMENT: " + extra;
                potEl.style.color = "#d500f9";
                detailEl.style.display = "block";
                detailEl.innerHTML = `REST: 5 MIN | WINDOW: ${Math.floor(Math.random() * 6) + 10} MIN`;
            } else if (eRoll < 80) {
                let base = Math.floor(Math.random() * 26) + 5;
                potEl.innerText = base + " STROKES";
                potEl.style.color = "#ff1744";
            } else {
                potEl.innerText = "CLEAN FINISH";
                potEl.style.color = "#00c853";
            }
        } else {
            potEl.innerText = "NONE";
            potEl.style.color = "#444";
        }

        // Timer Logic
        timeLeft = Math.floor(Math.random() * 2700) + 2700;
        sessionActive = true;
        document.getElementById('doneBtn').style.display = "block";
        updateTimer();
        timerInterval = setInterval(() => { 
            timeLeft--; 
            updateTimer(); 
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                if ("vibrate" in navigator) navigator.vibrate([500, 200, 500]);
            }
        }, 1000);
    }

    function updateTimer() {
        const h = Math.floor(timeLeft/3600), m = Math.floor((timeLeft%3600)/60), s = timeLeft%60;
        document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function finishSession() {
        sessionActive = false; 
        clearInterval(timerInterval);
        document.getElementById('status-msg').innerText = "SESSION LOGGED";
        document.getElementById('doneBtn').style.display = "none";
        if ("vibrate" in navigator) navigator.vibrate(50);
    }

    function increment(t) { 
        if(sessionActive) { 
            counts[t]++; 
            document.getElementById(t==='edge'?'edgeVal':'prosVal').innerText = counts[t]; 
            if ("vibrate" in navigator) navigator.vibrate(10);
        }
    }
</script>
</body>
</html>
